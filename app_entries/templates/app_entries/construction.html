{% extends "base.html" %}

{% block title %}Construction Details - {{ title }}{% endblock %}

{% block content %}

    <h1>{{ title }}</h1>
    <table border="1">
        {% for triple in triples %}
            <tr>
                <th>{{ triple.property }}</th>
                <td>{{ triple.object }}</td>
            </tr>
        {% endfor %}
    </table>

    <h2>Construction elements</h2>
    <div id="table-container"></div>

    <script>
    // Accessing elements sent by Flask
    const elements = {{ elements | tojson }};

    function createCrossTable(data) {
        const subjects = [...new Set(data.map(item => item.subject))];
        const properties = [...new Set(data.map(item => item.property))];

        // 2D map to store arrays of {object, href}
        const tableData = {};
        properties.forEach(property => {
            tableData[property] = {};
            subjects.forEach(subject => {
                tableData[property][subject] = [];
            });
        });

        // Populate with object + href
        data.forEach(({ subject, property, object, href }) => {
            tableData[property][subject].push({ object, href });
        });

        const desiredOrder = [
            'Surface form', 'Root', 'Stem / Lemma', 'hasTransliteration',
            'hasTranslation', 'Syntactic form', 'Optionality', 'WordOrder',
            'Syntactic function', 'Semantic role', 'Semantic contribution',
            'Semantic property', 'hasAnimacy', 'hasGender', 'has number',
            'hasPerson', 'hasCaseFeature', 'hasTenseFeature', 'hasMode',
            'hasVoice', 'type', 'comment'
        ];

        const table = document.createElement('table');
        const tbody = document.createElement('tbody');

        desiredOrder.forEach(property => {
            if (tableData[property]) {
                const row = document.createElement('tr');

                const cells = [
                    `<td>${property}</td>`,
                    ...subjects.map(subject => {
                        const values = tableData[property][subject];
                        // Render each object as a clickable link
                        return `<td>${values.map(v =>
                            v.href
                              ? `<a href="${v.href}" target="_blank">${v.object}</a>`
                              : v.object
                        ).join('<br>')}</td>`;
                    })
                ];

                row.innerHTML = cells.join('');
                tbody.appendChild(row);
            }
        });

        table.appendChild(tbody);
        return table;
    }

    // Render the table
    const container = document.getElementById('table-container');
    const table = createCrossTable(elements);
    container.appendChild(table);
</script>

<h2>Examples</h2>
    {% for subject, rows in grouped_examples.items() %}
        <h3>Example {{ loop.index }}</h3>
        <table>
            <tbody>
                {% for row in rows %}
                    <tr>
                        <th>{{ row.property }}</th>
                        <td>{{ row.object }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endfor %}

    <h2>Links</h2>
    <table border="1">
        {% for triple in links %}
            <tr>
                <td>{{ triple.property }}</td>
                <td>
                    {% if triple.href %}
                        <a href="{{ triple.href }}" target="_blank">{{ triple.object }}</a>
                    {% else %}
                        {{ triple.object }}
                    {% endif %}
                </td>
                <td>{{ triple.lang }}</td>
            </tr>
        {% endfor %}
    </table>


    <h2>Research</h2>
    <table border="1">
        {% for triple in research %}
            <tr>
                <th>{{ triple.property }}</th>
                <td>{{ triple.object }}</td>
            </tr>
        {% endfor %}
    </table>

    <h3>Evidence</h3>

    <table border="1">
        <tr>
            <th>Study</th>
            <th>Study type</th>
            <th>Study Summary</th>
        </tr>
        {% for triple in research_data %}
        <tr>
            <td>
                {% if triple.href %}
                    <a href="{{ triple.href }}" target="_blank">{{ triple.title }}</a>
                {% else %}
                    {{ triple.title }}
                {% endif %}
            </td>
            <td>{{ triple.type }}</td>
            <td>{{ triple.summary }}</td>
        </tr>
        {% endfor %}
    </table>


    <h2>Metadata</h2>
    <table border="1">
        {% for triple in metadata %}
            <tr>
                <th>{{ triple.property }}</th>
                <td>{{ triple.object }}</td>
            </tr>
        {% endfor %}
    </table>


    <a href="{{ url_for('app_entries.list_view') }}">Back to Constructions List</a>
</body>
{% endblock %}
