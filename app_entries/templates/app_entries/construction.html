{% extends "base.html" %}

{% block title %}Construction Details - {{ title }}{% endblock %}

{% block content %}

    <h1>{{ title }}</h1>
    <table border="1">
        {% for triple in triples %}
            <tr>
                <th>{{ triple.property }}</th>
                <td>{% if triple.property == 'Meaning of the construction' %}{{ triple.object|safe }}{% else %}{{ triple.object }}{% endif %}</td>
            </tr>
        {% endfor %}
    </table>

    {% if elements %}
    <h2>Construction elements</h2>
    <div id="table-container"></div>

    <script>
    // Accessing elements sent by Flask
    const elements = {{ elements | tojson }};

    function createCrossTable(data) {
    const subjects = [...new Set(data.map(item => item.subject))];
    const properties = [...new Set(data.map(item => item.property))];

    // 2D map to store arrays of {object, href}
    const tableData = {};
    properties.forEach(property => {
        tableData[property] = {};
        subjects.forEach(subject => {
            tableData[property][subject] = [];
        });
    });

    // Populate with object + href
    data.forEach(({ subject, property, object, href }) => {
        tableData[property][subject].push({ object, href });
    });

    const desiredOrder = [
        'Phonology', 'Surface form', 'Root', 'Stem / Lemma', 'hasTransliteration',
        'hasTranslation', 'Syntactic form', 'Optionality', 'WordOrder',
        'Syntactic function', 'Semantic role', 'Semantic contribution',
        'Semantic property', 'hasAnimacy', 'hasGender', 'has number',
        'hasPerson', 'hasCaseFeature', 'has tense', 'hasMode',
        'hasVoice', 'type', 'comment', 'Colloprofile'
    ];

    // Define a list of background colors -- they are also defined in CSS
    const colors = [
        '#F94144', //CE1
        '#F8961E', //CE2
        '#F9C74F', //CE3
        '#90BE6D', //CE4
        '#43AA8B', //CE5
        '#577590', //CE6
        '#FFD1DC', // Light pink; CE7
        '#E6E6FA', // Lavender; CE8
        '#98FB98', // Pale green; CE9
        '#F0E68C', // Khaki; CE10
        '#FFB6C1', // Light pink; CE11
        '#FFA07A', // Light salmon; CE12
        '#DDA0DD', // Plum
        '#90EE90'  // Light green
    ];

    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const tbody = document.createElement('tbody');

    // Create header row with "Property" and colored subjects
    const headerRow = document.createElement('tr');
    headerRow.innerHTML = `<td></td>${subjects.map((subject, index) =>
        `<td style="color: #3d3d3d; font-weight: bold; text-align: center; background-color: ${colors[index % colors.length]}">${subject}</td>`
    ).join('')}`;
    tbody.appendChild(headerRow);

    // Create data rows (no background color)
    desiredOrder.forEach(property => {
        if (tableData[property]) {
            const row = document.createElement('tr');
            const cells = [
                `<td>${property}</td>`,
                ...subjects.map(subject => {
                    const values = tableData[property][subject];
                    return `<td>${values.map(v =>
                        v.href
                            ? `<a href="${v.href}" target="_blank">${v.object}</a>`
                            : v.object
                    ).join('<br>')}</td>`;
                })
            ];
            row.innerHTML = cells.join('');
            tbody.appendChild(row);
        }
    });

    table.appendChild(tbody);
    return table;
}

    // Render the table
    const container = document.getElementById('table-container');
    const table = createCrossTable(elements);
    container.appendChild(table);
</script>
{% endif %}

{% if colloprofiles %}
<h3>Colloprofile</h3>
 {% for profile in colloprofiles %}
    <div class="chart-container">
      <div class="chart-title">Colloprofile for {{ profile.subject_name }}</div>
      <canvas id="chart-{{ loop.index }}"></canvas>
    </div>
  {% endfor %}

  <script>
    {% for profile in colloprofiles %}
      const ctx{{ loop.index }} = document.getElementById('chart-{{ loop.index }}').getContext('2d');
      new Chart(ctx{{ loop.index }}, {
        type: 'bar',
        data: {
          labels: {{ profile.collocations|map(attribute='word')|list|tojson|safe }},
          datasets: [{
            label: 'Frequency',
            data: {{ profile.collocations|map(attribute='frequency')|list|tojson|safe }},
            backgroundColor: '#b3c5ff',
            borderColor: '#0056b3',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: false,  // Title is already rendered in HTML
            },
            legend: {
              display: true,
              position: 'top'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Frequency'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Collocations'
              }
            }
          }
        }
      });
    {% endfor %}
  </script>
{% endif %}

{% if grouped_examples %}
<h2>Examples</h2>

    {% for subject, rows in grouped_examples.items() %}
        <h3>Example {{ loop.index }}</h3>
        <table>
            <tbody>
                {% for row in rows %}
                    <tr>
                        <th>{{ row.property }}</th>
                        <td>{% if row.property == 'Text' %}{{ row.object|safe }}{% else %}{{ row.object }}{% endif %}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endfor %}
{% endif %}

    {% if links %}
    <h2>Links</h2>
    <table border="1">
        {% for triple in links %}
            <tr>
                <td>{{ triple.property }}</td>
                <td>
                    {% if triple.href %}
                        <a href="{{ triple.href }}" target="_blank">{{ triple.object }}</a>
                    {% else %}
                        {{ triple.object }}
                    {% endif %}
                </td>
                <td>{{ triple.lang }}</td>
            </tr>
        {% endfor %}
    </table>
    {% endif %}


    <h2>Research</h2>
    <table border="1">
        {% for triple in research %}
            <tr>
                <th>{{ triple.property }}</th>
                <td>{{ triple.object }}</td>
            </tr>
        {% endfor %}
    </table>

    {% if research_data %}
    <h3>Evidence</h3>

    <table border="1">
        <tr>
            <th>Study</th>
            <th>Study type</th>
            <th>Study Summary</th>
        </tr>
        {% for triple in research_data %}
        <tr>
            <td>
                {% if triple.href %}
                    <a href="{{ url_for('app_studies.study_detail', uri=triple.href) }}" target="_blank"> {{ triple.title }} </a>
                {% else %}
                    {{ triple.title }}
                {% endif %}
            </td>
            <td>{{ triple.type }}</td>
            <td>{{ triple.summary }}</td>
        </tr>
        {% endfor %}
    </table>
    {% endif %}

    <h2>Metadata</h2>
    <table border="1">
        {% for triple in metadata %}
            <tr>
                <th>{{ triple.property }}</th>
                <td>{{ triple.object }}</td>
            </tr>
        {% endfor %}
        {% for ref in references %}
            <tr>
                <th>References</th>
                <td class="reference">
                    {{ ref.authors }}
                    {% if not ref.authors %} {{ ref.editors }} {% if not ref.editors %} {{ ref.source }} {% endif %} {% endif %}
                    {% if ref.year %} ({{ ref.year }}). {% endif %}
                    <i>{{ ref.title }}</i>.
                    {% if ref.doi %}<a href="{{ ref.doi_href }}" target="_blank">{{ ref.doi }}</a> {% endif %}
                </td>
            </tr>
    {% endfor %}
    </table>


    <form id="downloadForm" method="POST">
    <button type="submit">Download the construction (RDF Turtle)</button>
    </form>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get the current page's path
        const path = window.location.pathname;
        // Extract the "uri" part
        const uri = path.split('/').pop();
        // Set the form's action attribute using the correct URL
        document.getElementById('downloadForm').action =
            "{{ url_for('app_entries.download_subgraph', uri='') }}" + uri + "/submit";
    });
</script>

    <p>
    <a href="{{ url_for('app_entries.list_view') }}">Back to Constructions List</a>
    </p>

</body>
{% endblock %}
